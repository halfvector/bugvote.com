<!DOCTYPE html>
<meta charset="utf-8">
<style>

    path {
        fill: none;
        stroke-linejoin: round;
    }

    .sphere,
    .graticule {
        stroke: #aaa;
    }

    .equator {
        stroke: red;
        stroke-width: 2px;
    }

    circle {
        fill: none;
        stroke-width: 2.5px;
    }

    .land {
        fill: #222;
    }

    .boundary {
        fill: none;
        stroke: #fff;
        stroke-width: .5px;
    }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

    var width = 960,
            height = 500,
            rotate = [10, -10],
            velocity = [.01, -.00],
            time = Date.now();

    var projection = d3.geo.orthographic()
            .scale(240)
            .translate([width / 2, height / 2])
            .clipAngle(90 + 1e-6)
            .precision(.3);

    var path = d3.geo.path()
            .projection(projection);

    var graticule = d3.geo.graticule();

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

    svg.append("path")
            .datum({type: "Sphere"})
            .attr("class", "sphere")
            .attr("d", path);

    svg.append("path")
            .datum(graticule)
            .attr("class", "graticule")
            .attr("d", path);

    svg.append("path")
            .datum({type: "LineString", coordinates: [[-180, 0], [-90, 0], [0, 0], [90, 0], [180, 0]]})
            .attr("class", "equator")
            .attr("d", path);


    d3.json("world-110m.json", function(error, world) {
        svg.append("path")
                .datum(topojson.feature(world, world.objects.land))
                .attr("class", "land")
                .attr("d", path);

        svg.append("path")
                .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
                .attr("class", "boundary")
                .attr("d", path);
    });

    svg.on("mousedown", particle);

    // 40.6700° N, 73.9400° W

    var i = 0;
    function particle() {
        var m = d3.mouse(this);

        var d = [-73.94, 40.67];
        console.dir(d);
        var pt = projection([-73.94, 40.67]);

        svg.insert("circle", "body")
                .attr("cx", function(d) { return projection(d[0])[0]; })
                .attr("cy", function(d) { return projection(d[1])[1]; })
                //.attr("cy", pt[1])
                .style("stroke", d3.hsl((i = (i + 1) % 360), 1, .5))
                .style("stroke-opacity", 1)
                .attr("r", 4)
                .attr("d", d)
                //.attr("transform", function(t) { return "translate(" + projection(d) + ")";} )
                //.attr("d", path)
                //.transition()
                //.duration(2000)
                //.ease(Math.sqrt)
                //.style("stroke-opacity", 1e-6)
                //.remove();
    }

    svg.selectAll("circle").data([ { "type": "circle", "lon": -73.94, "lat": 40.67 } ])
            .enter()
            .append("circle")
            //.attr("cx", function(d) { return projection([d.lon, d.lat])[0]; })
            //.attr("cy", function(d) { return projection([d.lon, d.lat])[1]; })
            .attr("cx", function(d) { return d.lon; })
            .attr("cy", function(d) { return d.lat; })
            .style("stroke", d3.hsl((i = (i + 1) % 360), 1, .5))
            .style("stroke-opacity", 1)
            .attr("r", 4)
            .attr("d", path)
    ;

    d3.timer(function() {

        //var feature = svg.selectAll("path");

        var dt = Date.now() - time;
        projection.rotate([rotate[0] + velocity[0] * dt, rotate[1] + velocity[1] * dt]);
        svg.selectAll("path").attr("d", path);
        //svg.selectAll("circle").attr("d", path);
    });

</script>